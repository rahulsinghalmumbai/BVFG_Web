@* File: Views/Admin/Whatsapp.cshtml *@
@model BVFG_Web.Models.AdminModel.WhatsAppSendModel

@{
    ViewData["Title"] = "WhatsApp Messenger";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4"><i class="fab fa-whatsapp text-success"></i> WhatsApp Messenger</h2>
        </div>
    </div>

    <!-- QR Code Section -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-qrcode"></i> WhatsApp Connection Status</h5>
                </div>
                <div class="card-body text-center">
                    <div id="connectionStatus">
                        <button type="button" class="btn btn-primary btn-lg" onclick="initializeWhatsApp()">
                            <i class="fas fa-power-off"></i> Initialize WhatsApp
                        </button>
                    </div>
                    <div id="qrSection" style="display: none;">
                        <h5 class="text-muted mb-3">Scan QR Code with WhatsApp Mobile App</h5>
                        <img id="qrImage" src="" alt="QR Code" class="img-fluid border rounded" style="max-width: 300px;">
                        <p class="mt-3 text-success" id="scanningText">
                            <i class="fas fa-spinner fa-spin"></i> Waiting for scan...
                        </p>
                    </div>
                    <div id="readySection" style="display: none;">
                        <h4 class="text-success"><i class="fas fa-check-circle"></i> WhatsApp Connected!</h4>
                        <p class="text-muted">You can now send messages</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Messaging Tabs -->
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="single-tab" data-bs-toggle="tab" href="#singleMessage" role="tab">
                                <i class="fas fa-user"></i> Single/Multiple Messages
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="bulk-tab" data-bs-toggle="tab" href="#bulkMessage" role="tab">
                                <i class="fas fa-users"></i> Bulk Message
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <!-- Single Message Tab -->
                        <div class="tab-pane fade show active" id="singleMessage" role="tabpanel">
                            <form id="singleMessageForm">
                                <div class="mb-3">
                                    <label asp-for="Mobile" class="form-label">Mobile Numbers (with country code)</label>
                                    <input type="text" class="form-control" id="singleMobile" placeholder="+919876543210, +919876543211, +919876543212" required>
                                    <small class="text-muted">Format: +91XXXXXXXXXX (India) or +1XXXXXXXXXX (USA). Multiple numbers can be separated by commas.</small>
                                </div>
                                <div class="mb-3">
                                    <label asp-for="Message" class="form-label">Message</label>
                                    <textarea class="form-control" id="singleMessageText" rows="4" placeholder="Enter your message here..." required></textarea>
                                </div>
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fab fa-whatsapp"></i> Send Message
                                </button>
                            </form>
                            <div id="singleMessageResult" class="mt-3"></div>
                        </div>

                        <!-- Bulk Message Tab -->
                        <div class="tab-pane fade" id="bulkMessage" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Bulk Message</h5>
                                <button type="button" class="btn btn-outline-primary" onclick="downloadSampleFormat()">
                                    <i class="fas fa-download"></i> Download Sample
                                </button>
                            </div>
                            <form id="bulkMessageForm" enctype="multipart/form-data">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Excel Format:</strong> First column should contain mobile numbers (one per row). First row is header.
                                </div>
                                <div class="mb-3">
                                    <label for="excelFile" class="form-label">Upload Excel File (.xlsx)</label>
                                    <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls" required>
                                </div>
                                <div class="mb-3">
                                    <label for="bulkMessage" class="form-label">Message</label>
                                    <textarea class="form-control" id="bulkMessageText" rows="4" placeholder="Enter your message here..." required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="delaySeconds" class="form-label">Delay Between Messages (seconds)</label>
                                    <input type="number" class="form-control" id="delaySeconds" value="5" min="1" max="60">
                                    <small class="text-muted">Recommended: 5-10 seconds to avoid blocking</small>
                                </div>
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-paper-plane"></i> Send Bulk Messages
                                </button>
                            </form>
                            <div id="bulkMessageResult" class="mt-3"></div>
                            <div id="bulkProgress" class="mt-3" style="display: none;">
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Add jQuery first -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let checkStatusInterval;

        async function initializeWhatsApp() {
            try {
                const initializeBtn = $('#connectionStatus button');
                const originalBtnText = initializeBtn.html();
                initializeBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Initializing...');

                const response = await fetch('/admin/whatsapp/initialize', { method: 'POST', headers: { 'Content-Type': 'application/json' }});
                const result = await response.json();
                if (result.success) {
                    $('#connectionStatus').hide();
                    $('#qrSection').show();
                    startStatusCheck();
                } else {
                    showAlert('danger', 'Failed to initialize: ' + result.message);
                    initializeBtn.prop('disabled', false).html(originalBtnText);
                }
            } catch (error) {
                showAlert('danger', 'Error: ' + error.message);
                $('#connectionStatus button').prop('disabled', false).html('<i class="fas fa-power-off"></i> Initialize WhatsApp');
            }
        }

        async function checkStatus() {
            try {
                const response = await fetch('/admin/whatsapp/check-status');
                const result = await response.json();
                if (result.success) {
                    if (result.isReady) {
                        $('#qrSection').hide();
                        $('#readySection').show();

                        // Add connected number if available
                        if (result.connectedNumber) {
                            $('#readySection').html(`
                                <h4 class="text-success"><i class="fas fa-check-circle"></i> WhatsApp Connected!</h4>
                                <p class="text-muted"><strong>Connected as:</strong> ${result.connectedNumber}</p>
                                <p class="text-muted">You can now send messages</p>
                            `);
                        }
                        stopStatusCheck();
                    } else if (result.qrCode) {
                        $('#qrImage').attr('src', 'data:image/png;base64,' + result.qrCode);
                        
                    }
                }
            } catch (error) { console.error('Status check failed:', error); }
        }

        function startStatusCheck() {
            checkStatus();
            checkStatusInterval = setInterval(checkStatus, 3000);
        }

        function stopStatusCheck() {
            if (checkStatusInterval) clearInterval(checkStatusInterval);
        }

        async function downloadSampleFormat() {
            const downloadBtn = event.target;
            const originalText = downloadBtn.innerHTML;
            downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Downloading...';
            downloadBtn.disabled = true;

            try {
                // Fetch the file from server
                const response = await fetch('/admin/whatsapp/download-sample-format');

                if (!response.ok) {
                    throw new Error('File not found');
                }

                // Convert response to blob
                const blob = await response.blob();

                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'BulkWhatsAppFormat.xlsx';

                // Append to body, click and remove
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                // Show success message
                showAlert('success', 'Sample file downloaded successfully!', 'bulkMessageResult');

            } catch (error) {
                console.error('Download error:', error);
                showAlert('danger', 'Failed to download sample file: ' + error.message, 'bulkMessageResult');
            } finally {
                // Restore button after a short delay
                setTimeout(() => {
                    downloadBtn.innerHTML = originalText;
                    downloadBtn.disabled = false;
                }, 2000);
            }
        }

        $('#singleMessageForm').on('submit', async function(e) {
            e.preventDefault();
            const mobileInput = $('#singleMobile').val().trim();
            const message = $('#singleMessageText').val().trim();

            if (!mobileInput || !message) {
                return showAlert('danger', 'Please fill all fields', 'singleMessageResult');
            }

            // Split mobile numbers by comma and clean them
            const mobileNumbers = mobileInput.split(',').map(num => num.trim()).filter(num => num !== '');

            if (mobileNumbers.length === 0) {
                return showAlert('danger', 'Please enter at least one valid mobile number', 'singleMessageResult');
            }

            // Validate each mobile number format
            const mobileRegex = /^\+[1-9]\d{1,14}$/;
            const invalidNumbers = mobileNumbers.filter(num => !mobileRegex.test(num));

            if (invalidNumbers.length > 0) {
                return showAlert('danger', 'Invalid mobile number format: ' + invalidNumbers.join(', '), 'singleMessageResult');
            }

            // Show loader
            const submitBtn = $('#singleMessageForm button[type="submit"]');
            const originalBtnText = submitBtn.html();
            submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Sending Messages...');

            // Clear previous results
            $('#singleMessageResult').html('');

            try {
                const response = await fetch('/admin/whatsapp/send-single', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        Mobile: mobileNumbers.join(','),
                        Message: message,
                        IsMultiple: true
                    })
                });
                const result = await response.json();
                if(result.success) {
                    let successHtml = `<div class="alert alert-success alert-dismissible fade show" role="alert">
                        <h5><i class="fas fa-check-circle"></i> Message Sent Successfully</h5>
                        <p><strong>Total:</strong> ${result.totalCount} | <strong>Success:</strong> ${result.successCount} | <strong>Failed:</strong> ${result.failedCount}</p>`;

                    if (result.successNumbers && result.successNumbers.length > 0) {
                        successHtml += `<p><strong>Successful Numbers (${result.successCount}):</strong><br>${result.successNumbers.join(', ')}</p>`;
                    }

                    if (result.failedNumbers && result.failedNumbers.length > 0) {
                        successHtml += `<p><strong>Failed Numbers (${result.failedCount}):</strong><br>${result.failedNumbers.join(', ')}</p>`;
                    }

                    successHtml += `<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;

                    $('#singleMessageResult').html(successHtml);
                    $('#singleMessageForm')[0].reset();
                } else {
                    showAlert('danger', result.message, 'singleMessageResult');
                }
            } catch(error) {
                showAlert('danger', 'Error: ' + error.message, 'singleMessageResult');
            } finally {
                // Hide loader and restore button
                submitBtn.prop('disabled', false).html(originalBtnText);
            }
        });

        $('#bulkMessageForm').on('submit', async function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('excelFile');
            const message = $('#bulkMessageText').val().trim();
            const delaySeconds = $('#delaySeconds').val();
            if (!fileInput.files[0] || !message) return showAlert('danger', 'Please fill all fields', 'bulkMessageResult');

            // Show loader for bulk form
            const bulkSubmitBtn = $('#bulkMessageForm button[type="submit"]');
            const originalBulkBtnText = bulkSubmitBtn.html();
            bulkSubmitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Processing...');

            const formData = new FormData();
            formData.append('ExcelFile', fileInput.files[0]);
            formData.append('Message', message);
            formData.append('DelaySeconds', delaySeconds);

            $('#bulkProgress').show();
            $('.progress-bar').css('width', '50%').text('Sending...');

            try {
                const response = await fetch('/admin/whatsapp/send-bulk', { method: 'POST', body: formData });
                const result = await response.json();
                $('.progress-bar').css('width', '100%').text('Complete');
                if (result.success) {
                    let msg = result.message;
                    if(result.failedNumbers && result.failedNumbers.length>0) msg += '<br><strong>Failed:</strong> '+result.failedNumbers.join(', ');
                    showAlert('success', msg, 'bulkMessageResult');
                    $('#bulkMessageForm')[0].reset();
                } else showAlert('danger', result.message, 'bulkMessageResult');

                setTimeout(()=>{$('#bulkProgress').hide(); $('.progress-bar').css('width','0%').text('');},3000);
            } catch(error) {
                showAlert('danger', 'Error: '+error.message, 'bulkMessageResult');
                $('#bulkProgress').hide();
            } finally {
                // Hide loader and restore bulk button
                bulkSubmitBtn.prop('disabled', false).html(originalBulkBtnText);
            }
        });

        function showAlert(type, message, targetId=null) {
            const alertHtml = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
            if(targetId) $('#'+targetId).html(alertHtml); else $('.container-fluid').prepend(alertHtml);
        }

        $(window).on('beforeunload', stopStatusCheck);
    </script>
}

<style>
    .card {
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .card-header {
        border-radius: 10px 10px 0 0 !important;
    }

    #qrImage {
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .nav-tabs .nav-link {
        color: #666;
        font-weight: 500;
    }

        .nav-tabs .nav-link.active {
            color: #28a745;
            font-weight: 600;
        }

    .btn-success {
        background-color: #25D366;
        border-color: #25D366;
    }

        .btn-success:hover {
            background-color: #128C7E;
            border-color: #128C7E;
        }

    .btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .fa-spin {
        animation: fa-spin 2s infinite linear;
    }
</style>